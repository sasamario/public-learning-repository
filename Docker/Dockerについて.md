# Docker とは

一言で言うと「コンテナ型の仮想化技術」

### 従来の仮想化（ホスト型）

従来の仮想化（ホスト型）は、ホスト OS 上に仮想化ソフト/ハイパーバイザを使用して、仮想マシン/ゲスト OS を立ち上げ、その仮想マシンの中でミドルウェアの環境構築をし、プログラムを実行してアプリケーションを動かすという構造。  
※ハイパーバイザとは、1 台の物理コンピュータ上で複数の仮想マシン（VM）を動かしそれらを管理するためのソフトウェア

### Docker（コンテナ型）

従来のホスト型とは異なり、ゲスト OS を起動せずにホスト OS の上に動作している Docker Engine からコンテナと呼ばれるミドルウェアの環境構築がされた実行環境を作成し、その中でアプリケーションを動作させる。そのため軽量に動作する。

# Docker におけるデータ管理技術

Docker で起動したコンテナ内で扱うデータは、読み書き可能なレイヤーに置くこともできるが以下のデメリットがある

- コンテナが削除されたらデータが消えてしまう
- コンテナ間でデータ共有ができない
- コンテナレイヤーへデータ書き込みは通常のファイルシステムと異なるユニオンファイルシステムが使われているため、書き込み速度が遅い

そのため、Docker ではホストマシン上にデータを管理し、それをコンテナにマウントする手法が使われる。  
具体的には「volume」「bind mount」「tmpfs mount」といったものがある。

■ 公式ドキュメント

- https://docs.docker.jp/storage/index.html

## volume

Docker が管理する永続データ領域。

■ 特徴

- コンテナの外に存在する
  - 保存場所は通常、「/var/lib/docker/volumes/...」のように、コンテナ内からは普通のディレクトリに見えるが実際はホスト上の Docker 専用領域にある
- コンテナを削除してもデータは残る
  - 意図的にボリュームを削除するオプションをつけない限り、コンテナを削除してもボリュームは残る
- コンテナ間で共有可能

■ volume の指定方法  
以下は compose.yml で指定する方法（抜粋）。docker コマンドでも作成はできるがここでは省略する。

```yml
volumes:
  - my-volume:/app/data
```

左側の「my-volume」はボリューム名でなんでも良い。  
右側のパスはコンテナ内のパス。そこにマウントされる。

■volume の管理コマンド

```bash
# volumeの一覧確認
docker volume ls

# volumeの詳細を確認
docker volume inspect [volume名]

# volume を削除
docker volume rm [volume名]
```

■ よくあるトラブル

- [トラブル 1：ボリュームマウントしたファイルに書き込めない](https://zenn.dev/yamato_snow/articles/7ff2f3d4dd7055#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB1%EF%BC%9A%E3%83%9C%E3%83%AA%E3%83%A5%E3%83%BC%E3%83%A0%E3%83%9E%E3%82%A6%E3%83%B3%E3%83%88%E3%81%97%E3%81%9F%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%81%E3%81%AA%E3%81%84)

■ 公式ドキュメント

- [ボリュームの使用](https://docs.docker.jp/storage/volumes.html)

## bind mount

bind mount は、ホストの特定のディレクトリ（パス）を、そのままコンテナにマウントする仕組み。  
volumes と異なり Docker で管理するのではなく、ホスト側で管理するためホスト側で直接編集することができる。

■ 特徴

- ホストとリアルタイム同期（ホスト側で編集するとコンテナ内で即反映される）
  - 使いどころとしては、システムのソースを bind mount する（ソースを編集したら即時反映されるため開発で使われる）

頻繁にホスト側で触るソースなどはこの bind mount を使うことになる。

■bind mount の指定方法  
volumes と同じよう名指定方法だが違いとしては、左側ではホスト側のマウント先のパスを指定する。

```yml
volumes:
  - ./src:/var/www
```

左側はホスト側のパス、右側はコンテナのパスを指定する。

■ 公式ドキュメント

- [バインドマウントの使用](https://docs.docker.jp/storage/bind-mounts.html)

## tmpfs mount

tmpfs mount は、volume や bind mount とは異なりディスクには書き込まれず、ホストメモリ上（RAM）にのみ保持される。そのため、コンテナ停止と同時に消える一時ファイル。  
ホスト上やコンテナの書き込み可能なレイヤーのどちらにも保持したくない機密情報（秘密鍵、トークン、一時認証情報）を扱う一時ファイルの保存などに便利。あとは消えても問題ないキャッシュなど。

■ 特徴

- メモリ上に作られる（SSD/HDD を使わない）
- 永続化されない（コンテナ停止、再起動、Docker 再起動等で消える）
- 高速
- ディスクに残らない

■tmpfs mount の指定方法

```yml
tmpfs:
  - /tmp:size=64m,mode=1777
```

基本的には一時ファイルのパスを指定するだけ。ただ、メモリ上限の指定などをしないと使い放題となってしまうため、最低限上記で指定しているようなオプションを指定する方が良いらしい。

- size：メモリ上限
- mode：パーミッション

■ 公式ドキュメント

- [tmpfs マウントの使用](https://docs.docker.jp/storage/tmpfs.html)

# Docker Compose について

Docker Compose とは、複数のコンテナを定義し実行する Docker アプリケーションのためのツール。  
YAML ファイルを使い、アプリケーションのサービスを設定することで、コマンドを実行すると設定に基づいた全てのサービスを生成、起動する。

もし、Docker Compose を使わずに docker コマンドで一つずつ生成、起動などをしようとするとコマンドの実行が大変...。  
Docker Compose を使うことで事前に各サービスの設定はあらかじめ compose.yml に定義しておくことでコマンド 1 つで起動することができる！

■ 公式ドキュメント

- [Docker Compose](https://docs.docker.jp/compose/toc.html)

# 参考サイト

- [【図解】Docker の全体像を理解する -前編-](https://qiita.com/etaroid/items/b1024c7d200a75b992fc)
- [【図解】Docker の全体像を理解する -中編-](https://qiita.com/etaroid/items/88ec3a0e2d80d7cdf87a)
- [【図解】Docker の全体像を理解する -後編-](https://qiita.com/etaroid/items/40106f13d47bfcbc2572)
- [【完全版】Docker を使うエンジニアのための Linux 基礎マスター](https://zenn.dev/yamato_snow/articles/7ff2f3d4dd7055)
