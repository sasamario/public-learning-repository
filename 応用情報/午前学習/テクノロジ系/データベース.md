# 学習まとめ

## DBMS と関係データベース

キタミ式 DBMS と関係データベース p430~

### 基本用語

関係データベースの基本用語。問題によって表現も変わるため、それぞれ押さえておくこと！

- 表（テーブル）：複数のデータを収容する場所
- 行（レコード、タプル、組）：1 件分のデータ
- 列（フィールド、属性）：データを構成する各項目

### データベース設計

データベースの設計は以下の手順で行う。

1. 概念設計（現実からデータ構造を抽出してモデル化）→E-R 図、UML のクラス図等
2. 論理設計（データベースで表現する形にモデル化）→ 関係モデル、階層モデル、ネットワークモデル等
3. 物理設計（ハードウェアなどで物理的な構造をモデル化）→DB の種類、ハードウェア、データファイルの格納場所等

### スキーマ

スキーマはデータベースの構造や仕様を設定するもの。  
標準的な規格は、「3 層スキーマ構造」というもので以下の 3 つの層に定義を分けることでデータの独立性を高めている。

- 外部スキーマ（ビュー表など利用者の必要とするデータの見方を表現）
- 概念スキーマ（データの論理的関係を表現。E-R 図の作成、表定義、表の正規化など）
- 内部スキーマ（データの物理的関係を表現。ファイル編成やインデックスの設定など）

外部スキーマがプログラムよりで、内部スキーマがハードウェアよりというのを覚えておくと良い。  
参考過去問：[3 層スキーマモデル](https://www.ap-siken.com/kakomon/04_haru/q27.html)

## 正規化

正規化には以下の正規形がある。

- 非正規系（正規化されていない、繰り返し部分を持つ）
- 第 1 正規系（非正規系から繰り返し部分を分離させた状態）
- 第 2 正規系（第 1 正規系から、部分関数従属している列を切り出した状態）
- 第 3 正規系（第 2 正規系から、主キー以外の列に関数従属している列を切り出した状態）

### 関数従属

主キーが決まれば、列の値が一意に定まる関係を関数従属という。

### 部分関数従属

複合キー（主キーの一部）の項目だけで、列の値が一意に定まる関係を部分関係従属という。

## トランザクション管理と排他制御

### ACID 特性

トランザクション処理に対して以下 4 つの特性が必須とされている。

- Atomicity（原子性）：トランザクション処理が全て実行される or 全て実行されないのいずれかであること
- Consistency（一貫性）：データベースの内容に矛盾がない状態であること
- Isolation（隔離性）：複数のトランザクションを同時に実行した場合と、順番に実行した場合の処理結果が一致すること
- Durability（耐久性）：障害が発生してもデータが消失しないこと（復旧手段が保証されている必要あり）

### 共有ロックと専有ロック

共有ロック：各ユーザはデータを読むことはできるが、書くことはできない  
専有ロック：他ユーザはデータの読み書きができない

| 後続ロック \ 先行ロック | 共有ロック | 専有ロック |
| :---------------------: | :--------: | :--------: |
|       共有ロック        |    　 ◯    |  　 × 　   |
|       専有ロック        |    　 ×    |  　 × 　   |

参考過去問：[ロックの動作に関する記述](https://www.ap-siken.com/kakomon/25_haru/q31.html)

### デッドロック

排他制御において、互いに相手のロックしている資源の解除待ちとなり処理が進まなくなる状態をデッドロックという。  
以下のような形式で出題されるので、慣れておくと良い。

参考過去問：[デッドロックとなる時点](https://www.ap-siken.com/kakomon/29_haru/q29.html)  
参考過去問：[デッドロック](https://www.ap-siken.com/kakomon/20_haru/q66.html)

### ストアドプロシージャ

データベースを操作する一連の処理（SQL）を一つのプログラムにまとめ、DB に保存しておくことをストアドプロシージャという。

#### ■ メリット

- 複数の SQL を都度実行する必要がないため、ネットワークの負荷が減る
- プロシージャは SQL 文の解析済みなため、処理速度の向上が見込める

## データベースの障害管理

データベースの障害回復にはバックアップファイルやジャーナルファイルを使う。  
ジャーナルファイルとはログファイルで、例えばバックアップ後に障害が起きた場合は、バックアップ+ジャーナルを使って復旧させる。

### ロールバック

トランザクション処理中に何らかの障害があった場合、ロールバックする必要がある。  
この時「更新前ジャーナル」を使って、トランザクション開始前の状態に戻す。

### ロールフォワード

トランザクション処理以外で障害が発生した場合、定期的に取得しているバックアップから復旧させる。  
ただ最後のバックアップ以降の変更については、更新後ジャーナルからデータを取得し復旧させる。この一連の処理をロールフォワードという。

### チェックポイント

DBMS には、処理効率向上のため更新データを補助記憶装置にすぐに書き出さず、主記憶装置のバッファに保持するものがある（主記憶装置のバッファを更新する方が処理が速いため）。  
この主記憶装置のバッファ内データは、定期的に補助記憶装置側のデータベースに反映される。この反映を行うイベントを「チェックポイント」という。

チェックポイントのタイミングによって、障害が起きた場合の対応が変わる。

1. チェックポイント前にトランザクション処理がコミットまで完了している場合 → チェックポイント前に確定しているため復旧は不要
2. チェックポイント前にトランザクションを開始し、チェックポイント後にコミットした場合 → チェックポイントから復旧後、ロールフォワードをする
3. チェックポイント前にトランザクションを開始し、コミットが完了しないまま障害が発生した場合 → ロールバックする

以下の過去問は、ロールバック・ロールフォワード・チェックポイントに関する良い問題（+DB に対する処理の種類まで指定がある）。
参考過去問：[DBMS の障害回復](https://www.ap-siken.com/kakomon/05_aki/q30.html)

## 分散データベース

物理的に分かれている複数のデータベースを、見かけ上一つのデータベースとして扱えるようにしたシステムを「分散データベースシステム」と呼ぶ。  
分散データベースでデータの整合性を保つための方式が、2 相コミット。

### 2 相コミットの流れ

1. 各 DB に対して、コミットできるか確認（調停者 → 参加者）
2. 各 DB から返答がくる（参加者 → 調停者）
3. 全 DB がコミット可能ならコミット、1 つでもコミット負荷なら全てロールバックをするよう指示をだす（調停者 → 参加者）

■ ポイント  
・障害の発生タイミングによっては、コミットもロールバックも行えない状態となる（上記例だと 3 を行う前に障害が起きると、参加者は待機状態となってしまう）  
・仮に 1 のコミットできるかの確認や 2 の参加者からの返答の際に障害が発生した場合は、タイムアウトとみなしてロールバックする  
・調停者は必ず 1

参考過去問：[2 相コミットプロトコル](https://www.ap-siken.com/kakomon/21_aki/q31.html)  
参考過去問：[2 相コミット中の障害発生](https://www.ap-siken.com/kakomon/06_aki/q27.html)

### 分散データベースに求められる 6 つの透過性

分散データベースシステムは利用者から、DB が分かれていることを意識させないことが大事らしい。

1. データモデルに対する透過性：DBMS が異種でも、利用者は違いを意識せず利用できること
2. 分割に対する透過性：1 つのテーブルが分割されていても意識せず利用できること
3. 移動に対する透過性：データが別のサーバに移動しても、利用者は配置されたサーバを意識せず利用できること
4. 複製に対する透過性：複数のサーバに同一のデータが重複して存在しても、利用者は重複を意識せず利用できること
5. 位置に対する透過性：DB がどこにあっても意識せず利用できること
6. 障害に対する透過性：障害が起きていても、利用者は意識せず利用できること

## データ操作

### NULL の扱い

NULL 値の扱いは、IS NULL 以外の条件ではすべて false を返す性質がある。  
そのため、例えば LIKE 句で曖昧検索をする場合 NULL はマッチしない。  
以下の参考過去問のような形式で NULL 値の扱いについて触れられる問題をちょこちょこ見かけるので理解しておくこと。

参考過去問：[SQL 文を実行した結果の行数は幾つか](https://www.ap-siken.com/kakomon/27_haru/q26.html)  
参考過去問：[NULL 値を含む列に対しての SQL](https://www.ap-siken.com/kakomon/23_aki/q29.html)

### 直積について

直積は、2 つの関係（表）に含まれる要素のすべての組み合わせからなる表。  
以下参考過去問はどちらかというとタプル=行、属性=列　ということがわかっているかどうかな気もする...。

参考過去問：[関係代数における直積](https://www.ap-siken.com/kakomon/20_haru/q64.html)

## その他語句

### オプティマイザ（最適化）

オプティマイザは、SQL が実行された際対象となるレコードの取得時間を最小とするようにアクセスパスを最適化する DBMS の機能。  
オプティマイザは、クエリの実行計画を評価し問い合わせ内容に応じて最も効率が良い方法を選択する。  
後述するコストベースアプローチにより、DBMS の表やインデックスなどの統計情報をもとに最適化を図る。

#### アクセスパスとは？

DB からデータを取り出す経路のこと。
アクセスパスを選択する基準には「コストベースアプローチ」と「ルールベースアプローチ」があり、コストベースアプローチが一般的とのこと。  
コストベースアプローチは、DBMS の表やインデックスの統計情報をもとにコストを見積り効率的な実行計画を作成する方法。

参考過去問：[オプティマイ座が必要とする情報](https://www.ap-siken.com/kakomon/03_haru/q30.html)

### B+木インデックス

B+木インデックスは、気の深さが一定ではのみが値を持つ平衡木を用いたインデックスで、RDBMS のインデックス法として普及している。  
B 木（バランス木）というデータ構造の一種を用いている。データの検索、挿入、削除を効率的に行うために設計された木構造。

#### 特徴

- 根から節を辿っていくことで目的のデータを検索できる
- すべてのキー値が同じ深さにあるためデータ量が増加してもパフォーマンスの低下が少なく効率よく処理できる
- ★ データの分布に偏りがある場合、NULL 値および否定を含む検索条件では効果を発揮できない

<img src="https://github.com/user-attachments/assets/13e5f6e8-29b3-4916-9d9a-c1bca1861be7" width="400px">

数字はキー値。2 つのキー値があり、左のキーより小さいもの、左右のキーの間のもの、右のキーより大きいものでそれぞれ子ノードを持つ。  
各ノードで目的のキーがどの範囲に属するかを判断し、対応するこノードへ移動しデータを見つけることができる。

■ 参考  
参考過去問：[B+木インデックス](https://www.ap-siken.com/kakomon/30_aki/q29.html)  
[B 木とは？意味をわかりやすく簡単に解説](https://xexeq.jp/blogs/media/it-glossary6)

### 導出表

導出表は、1 つ以上の基礎となる実表から関係演算・集合演算といった SQL によって作成される仮想的な表全般を指す。  
ビューは導出表の 1 つの形態であり、導出表に名前をつけて実表と同じように参照できるようにしたもの。  
導出表は実データを持たず、参照・更新要求のたびに実表に関係演算・集合演算を行なって作り出される。

参考過去問：[実表と導出表に関する記述]()

### SQL 参照操作

参考過去問：[SET DEFAULT 句](https://www.ap-siken.com/kakomon/18_aki/q70.html)

#### CASCADE 句

CASCADE 句は、参照される側の行が削除・更新された場合それを参照する側の行も同時に削除・更新する指定。

#### RESTRICT 句

RESTRICT 句は、参照する側の行が残っている場合に参照される行の更新・削除をできないようにする指定。

#### SET DEFAULT 句

参照される側の行が削除・更新された場合それを参照する側の行に既定値を設定する指定

### 外部キー

表と表を関連づけるため、他の表の主キーを参照する列のことを外部キーと呼ぶ。
外部キーは、参照制約と呼ばれる「外部キーに含まれる値は、参照先となる表の列内に必ず存在しなければならない」という制約がある。

参考過去問：[キーに関する記述のうち適切なもの](https://www.ap-siken.com/kakomon/17_aki/q63.html)
