# 学習まとめ

## DBMS と関係データベース

キタミ式 DBMS と関係データベース p430~

### 基本用語

関係データベースの基本用語。問題によって表現も変わるため、それぞれ押さえておくこと！

- 表（テーブル）：複数のデータを収容する場所
- 行（レコード、タプル、組）：1 件分のデータ
- 列（フィールド、属性）：データを構成する各項目

### データベース設計

データベースの設計は以下の手順で行う。

1. 概念設計（現実からデータ構造を抽出してモデル化）→E-R 図、UML のクラス図等
2. 論理設計（データベースで表現する形にモデル化）→ 関係モデル、階層モデル、ネットワークモデル等
3. 物理設計（ハードウェアなどで物理的な構造をモデル化）→DB の種類、ハードウェア、データファイルの格納場所等

### スキーマ

スキーマはデータベースの構造や仕様を設定するもの。  
標準的な規格は、「3 層スキーマ構造」というもので以下の 3 つの層に定義を分けることでデータの独立性を高めている。

- 外部スキーマ（ビュー表など利用者の必要とするデータの見方を表現）
- 概念スキーマ（データの論理的関係を表現。E-R 図の作成、表定義、表の正規化など）
- 内部スキーマ（データの物理的関係を表現。ファイル編成やインデックスの設定など）

外部スキーマがプログラムよりで、内部スキーマがハードウェアよりというのを覚えておくと良い。  
参考過去問：[3 層スキーマモデル](https://www.ap-siken.com/kakomon/04_haru/q27.html)

## 正規化

正規化には以下の正規形がある。

- 非正規系（正規化されていない、繰り返し部分を持つ）
- 第 1 正規系（非正規系から繰り返し部分を分離させた状態）
- 第 2 正規系（第 1 正規系から、部分関数従属している列を切り出した状態）
- 第 3 正規系（第 2 正規系から、主キー以外の列に関数従属している列を切り出した状態）

### 関数従属

主キーが決まれば、列の値が一意に定まる関係を関数従属という。

### 部分関数従属

複合キー（主キーの一部）の項目だけで、列の値が一意に定まる関係を部分関係従属という。

## トランザクション管理と排他制御

### ACID 特性

トランザクション処理に対して以下 4 つの特性が必須とされている。

- Atomicity（原子性）：トランザクション処理が全て実行される or 全て実行されないのいずれかであること
- Consistency（一貫性）：データベースの内容に矛盾がない状態であること
- Isolation（隔離性）：複数のトランザクションを同時に実行した場合と、順番に実行した場合の処理結果が一致すること
- Durability（耐久性）：障害が発生してもデータが消失しないこと（復旧手段が保証されている必要あり）

### 共有ロックと専有ロック

共有ロック：各ユーザはデータを読むことはできるが、書くことはできない  
専有ロック：他ユーザはデータの読み書きができない

| 後続ロック \ 先行ロック | 共有ロック | 専有ロック |
| :---------------------: | :--------: | :--------: |
|       共有ロック        |    　 ◯    |  　 × 　   |
|       専有ロック        |    　 ×    |  　 × 　   |

参考過去問：[ロックの動作に関する記述](https://www.ap-siken.com/kakomon/25_haru/q31.html)

### ストアドプロシージャ

データベースを操作する一連の処理（SQL）を一つのプログラムにまとめ、DB に保存しておくことをストアドプロシージャという。

#### ■ メリット

- 複数の SQL を都度実行する必要がないため、ネットワークの負荷が減る
- プロシージャは SQL 文の解析済みなため、処理速度の向上が見込める

## データベースの障害管理

データベースの障害回復にはバックアップファイルやジャーナルファイルを使う。  
ジャーナルファイルとはログファイルで、例えばバックアップ後に障害が起きた場合は、バックアップ+ジャーナルを使って復旧させる。

### ロールバック

トランザクション処理中に何らかの障害があった場合、ロールバックする必要がある。  
この時「更新前ジャーナル」を使って、トランザクション開始前の状態に戻す。

### ロールフォワード

トランザクション処理以外で障害が発生した場合、定期的に取得しているバックアップから復旧させる。  
ただ最後のバックアップ以降の変更については、更新後ジャーナルからデータを取得し復旧させる。この一連の処理をロールフォワードという。

### チェックポイント

DBMS には、処理効率向上のため更新データを補助記憶装置にすぐに書き出さず、主記憶装置のバッファに保持するものがある（主記憶装置のバッファを更新する方が処理が速いため）。  
この主記憶装置のバッファ内データは、定期的に補助記憶装置側のデータベースに反映される。この反映を行うイベントを「チェックポイント」という。

チェックポイントのタイミングによって、障害が起きた場合の対応が変わる。

1. チェックポイント前にトランザクション処理がコミットまで完了している場合 → チェックポイント前に確定しているため復旧は不要
2. チェックポイント前にトランザクションを開始し、チェックポイント後にコミットした場合 → チェックポイントから復旧後、ロールフォワードをする
3. チェックポイント前にトランザクションを開始し、コミットが完了しないまま障害が発生した場合 → ロールバックする

以下の過去問は、ロールバック・ロールフォワード・チェックポイントに関する良い問題（+DB に対する処理の種類まで指定がある）。
参考過去問：[DBMS の障害回復](https://www.ap-siken.com/kakomon/05_aki/q30.html)

## 分散データベース

物理的に分かれている複数のデータベースを、見かけ上一つのデータベースとして扱えるようにしたシステムを「分散データベースシステム」と呼ぶ。  
分散データベースでデータの整合性を保つための方式が、2 相コミット。

### 2 相コミットの流れ

1. 各 DB に対して、コミットできるか確認
2. 各 DB から返答がくる
3. 全 DB がコミット可能ならコミット、1 つでもコミット負荷なら全てロールバックをする

### 分散データベースに求められる 6 つの透過性

分散データベースシステムは利用者から、DB が分かれていることを意識させないことが大事らしい。

1. データモデルに対する透過性：DBMS が異種でも、利用者は違いを意識せず利用できること
2. 分割に対する透過性：1 つのテーブルが分割されていても意識せず利用できること
3. 移動に対する透過性：データが別のサーバに移動しても、利用者は配置されたサーバを意識せず利用できること
4. 複製に対する透過性：複数のサーバに同一のデータが重複して存在しても、利用者は重複を意識せず利用できること
5. 位置に対する透過性：DB がどこにあっても意識せず利用できること
6. 障害に対する透過性：障害が起きていても、利用者は意識せず利用できること

## その他語句

### オプティマイザ（最適化）

オプティマイザは、SQL が実行された際対象となるレコードの取得時間を最小とするようにアクセスパスを最適化する DBMS の機能。  
オプティマイザは、クエリの実行計画を評価し問い合わせ内容に応じて最も効率が良い方法を選択する。  
後述するコストベースアプローチにより、DBMS の表やインデックスなどの統計情報をもとに最適化を図る。

#### アクセスパスとは？

DB からデータを取り出す経路のこと。
アクセスパスを選択する基準には「コストベースアプローチ」と「ルールベースアプローチ」があり、コストベースアプローチが一般的とのこと。  
コストベースアプローチは、DBMS の表やインデックスの統計情報をもとにコストを見積り効率的な実行計画を作成する方法。

参考過去問：[オプティマイ座が必要とする情報](https://www.ap-siken.com/kakomon/03_haru/q30.html)
