# 句

## WITH

WITH は、一時的にサブクエリに名前をつけて管理することができる機能。共通テーブル式(CTE：Common Table Expression)という。  
テーブル結合するクエリや複雑なサブクエリを記述する際に、WITH 句を使うことで可読性が向上する。

■ 構文

```sql
WITH [一時テーブル名](列名, ...) AS (サブクエリ)
```

■ 例

```sql
WITH tmp_users AS (SELECT id, name FROM users)
SELECT \* FROM tmp_users;
```

WITH で定義した一時テーブルは、通常のテーブルのように使うことができる。

## WITH RECURSIVE

再帰的な共通テーブル式(再帰 CTE)。  
階層構造（親子関係を持つデータ）や再帰的な関係を持つデータを効率的に取得することができる。

[R6 秋 トレーディングカードの個人売買サイトの構築](https://www.ap-siken.com/kakomon/06_aki/pm06.html) で出た。

■ 構文

```sql
WITH RECURSIVE [再帰テーブル名](列名, ...)  AS (
  -- 基底部：再起処理の初期状態（終了条件のないクエリ）
  初期クエリ
  UNION ALL
  -- 再帰部：前回の結果をもとに繰り返し処理を行うクエリ
  再帰クエリ（再起テーブル名を参照する）
)
```

- 基底部：再起処理の開始点。初期のクエリ結果を返す。
- 再帰部：再帰テーブルを参照し、新しい結果を生成する。これが終了条件に達するまで繰り返される。
- UNION ALL：基底部と再帰部

■UNION と UNION ALL の違い

- UNION：重複行は除外
- UNION ALL：重複行もそのまま保持

■WITH RECURSIVE で UNION ALL が推奨される理由  
UNION は重複チェックを行うため、再起的な処理ではパフォーマンス面で UNION ALL に劣る。  
また、再帰クエリの中間結果で重複が発生することがあるため、UNION ALL の方が推奨される。

## BETWEEN

BETWEEN 句は、指定した範囲内の値を取得するための条件式に使用される。  
数値だけでなく、日付型や文字列型のデータにも対応する。

[R6 春 クラウドサービスを活用した情報提供システムの構築](https://www.ap-siken.com/kakomon/06_haru/pm06.html) で出た。

■ 構文

```sql
列名 BETWEEN 下限値 AND 上限値
列名 NOT BETWEEN 下限値 AND 上限値
```

なお、下限値と上限値の値も条件に含まれるため以下と同じ意味。

```sql
列名 >= 下限値 AND 列名 <= 上限値
```

■ 注意点  
・範囲の順序は指定通り（小さい値から先に書く）こと  
・NULL の扱い（NULL が含まれている場合、BETWEEN 句ではその行は除外される）  
・日付型を扱う場合は、データベースのフォーマットに従った正しい形式で指定すること
